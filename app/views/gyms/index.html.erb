<div class="container mt-5">
  <h1 class="mb-4">Nearby Gyms</h1>
  <%= form_with url: search_gyms_path, method: :get, local: true, class: "mb-4" do %>
    <div class="input-group">
      <%= text_field_tag :location, params[:location], placeholder: 'Enter your location', class: "form-control" %>
      <div class="input-group-append">
        <%= submit_tag 'Search', class: "btn btn-primary" %>
      </div>
    </div>
  <% end %>

  <% if flash[:alert] %>
    <div class="alert alert-danger"><%= flash[:alert] %></div>
  <% end %>

  <div id="map" style="width: 100%; height: 400px;" class="mb-4"></div>

  <ul class="list-group">
    <% @gyms.each do |gym| %>
      <li class="list-group-item">
        <%= link_to gym.name, gym_path(gym), class: "text-decoration-none" %>
      </li>
    <% end %>
  </ul>
</div>

<script>
  mapboxgl.accessToken = '<%= ENV['MAPBOX_ACCESS_TOKEN'] %>';

  var gyms = <%= raw @gyms.to_json %>;
  var defaultCenter = [0, 0]; // Default coordinates if no gyms are found

  var mapCenter = gyms.length > 0 ? [gyms[0].longitude, gyms[0].latitude] : defaultCenter;

  var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v11',
    center: mapCenter, // Set the map center to the first gym's coordinates or default center
    zoom: 10 // Set an appropriate zoom level
  });

  gyms.forEach(function(gym) {
    new mapboxgl.Marker()
      .setLngLat([gym.longitude, gym.latitude])
      .setPopup(new mapboxgl.Popup().setHTML('<h4>' + gym.name + '</h4><p>' + gym.address + '</p>'))
      .addTo(map);
  });
</script>
