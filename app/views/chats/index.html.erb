<div class="container mt-5">
  <h1 class="mb-4">Your Messages</h1>
  <div id="messages" class="mb-4">
    <%= render @chats %>
  </div>

  <%= form_with(model: @chat, local: true, id: 'new_message', class: "form-inline") do |form| %>
    <% receiver_id = params[:receiver_id].presence || @default_receiver_id %>
    <%= form.hidden_field :receiver_id, value: receiver_id %>
    <%= form.text_area :message, class: "form-control mr-2" %>
    <%= form.submit 'Send', class: "btn btn-primary" %>
  <% end %>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const chatChannel = App.cable.subscriptions.create({ channel: "ChatChannel", chat_id: <%= params[:chat_id] %> }, {
      received(data) {
        const messages = document.getElementById('messages');
        messages.insertAdjacentHTML('beforeend', data.message);
      },
      send_message(message, receiver_id) {
        this.perform('send_message', { chat: { message: message, receiver_id: receiver_id } });
      }
    });

    const form = document.getElementById('new_message');
    form.addEventListener('submit', (event) => {
      event.preventDefault();
      const messageField = form.querySelector('textarea');
      chatChannel.send_message(messageField.value, form.querySelector('input[name="chat[receiver_id]"]').value);
      messageField.value = '';
    });
  });
</script>
